/* Ember.js adapter for caliper.js v0.0.2 (c) 2013 Coherence Inc (https://github.com/caliper-io/caliper-ember) */
!function(a,b){!function(){"use strict";var a={VERSION:"0.2.0-pre"},b=window.Caliper||{};if(b.loaded===!0){var c;return a.VERSION===b.VERSION?(c="Already loaded caliper.core  v"+a.VERSION,b.config&&b.config.debug===!0&&("function"==typeof b.warn?b.warn(c):window.console&&"function"==typeof window.console.warn?window.console.warn("[Caliper] "+c):window.console&&"function"==typeof window.console.log&&window.console.log("[Caliper] **WARNNING** "+c))):(c="Failed to load caliper.core  v"+a.VERSION+": "+"another version of caliper.core (v"+b.VERSION+") was already loaded","function"==typeof b.error?b.error(c):window.console&&"function"==typeof window.console.error?window.console.error("[Caliper] "+c):window.console&&"function"==typeof window.console.log&&window.console.log("[Caliper] **ERROR** "+c)),void 0}a.config={apiKey:null,beaconURL:"//b.caliper.io/_.gif",debug:!1,enabled:!0};for(var d in b.config)b.config.hasOwnProperty(d)&&(a.config[d]=b.config[d]);var e=function(){return!!(!window.attachEvent||window.addEventListener||window.navigator.userAgent.indexOf("MSIE 8.0")>=0)}();if(a.enabled=!(!e||!a.config.enabled),a.enabled===!1)return a.debug&&window.console&&"function"==typeof window.console.log&&window.console.log("[Caliper] Caliper is disabled"),window.Caliper=a,void 0;if(Date.now||(Date.now=function(){return(new Date).valueOf()}),a.__empty__=function(){},a.log=window.console&&"function"==typeof window.console.log?function(b){a.config.debug===!0&&window.console.log("[Caliper] "+b)}:a.__empty__,a.warn=window.console&&"function"==typeof window.console.warn?function(b){a.config.debug===!0&&window.console.warn("[Caliper] "+b)}:window.console&&"function"==typeof window.console.log?function(b){a.config.debug===!0&&window.console.log("[Caliper] **WARNNING** "+b)}:a.__empty__,a.error=window.console&&"function"==typeof window.console.error?function(a){window.console.error("[Caliper] "+a)}:window.console&&"function"==typeof window.console.log?function(a){window.console.log("[Caliper] **ERROR** "+a)}:a.__empty__,a.slice=function(a){return Array.prototype.slice.call(a)},a.setImmediate="function"==typeof window.setImmediate?function(){return window.setImmediate.apply(window,arguments)}:function(a){var b=[].slice.call(arguments,1);return window.setTimeout(function(){a.apply(null,b)},0)},a.randomStr=function(a){var b=a.length;return function(c){for(var d=[],e=0;c>e;e++)d.push(a[Math.floor(Math.random()*b)]);return d.join("")}}("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789"),a.__super__=function(){throw new Error("Cannot call Caliper.__super__ outside of a wrapped function")},a.wrap=function(b,c){return function(){var d=a.__super__,e=this,f=a.slice(arguments);try{return a.__super__="function"==typeof b?function(){return this===a?0===arguments.length?b.apply(e,f):b.apply(e,arguments):b.apply(this,arguments)}:a.__empty__,c.apply(this,arguments)}finally{a.__super__=d}}},a.aliasMethodChain=function(a,b,c,d){var e=a[b];if("function"==typeof e){var f="__"+b+"_without_"+c+"__",g="__"+b+"_with_"+c+"__";a[f]=e,a[g]=a[b]=d}return a},a.nameFor=function(a){return"string"==typeof a||a instanceof String?a:a&&a.constructor?a.__name__||a.constructor.__name__:void 0},a.log("Initializing caliper.core v"+a.VERSION+"..."),!a.config.apiKey||!a.config.apiKey.length)return a.error("Failed to load caliper.core: did you forget to set your Caliper API key?"),void 0;a.sessionID=a.randomStr(16),a.log("Generated session ID "+a.sessionID),a.visitorID=a.config.visitor||function(){var b,c=function(){for(var a="_cpv=",b=document.cookie.split(";"),c=0;c<b.length;c++){var d=b[c].replace(/^\s+|\s+$/g,""),e=d.indexOf(a);if(0===e)return d.substring(5,d.length)}return void 0},d=function(a){var b=new Date(Date.now()+631152e5);return document.cookie="_cpv="+a+"; expires="+b.toGMTString()+"; path=/",a};return b=c(),b?a.log("Using existing visitor ID "+b):(b=a.randomStr(16),a.log("Generated visitor ID "+b)),d(b)}();var f=0,g=function(a){"string"==typeof a&&(a=[a]);for(var b=[],c=0;c<a.length;c++)b.push(encodeURIComponent(a[c]).replace(/[-_~%]/g,function(a){switch(a){case"-":return"~2D";case"_":return"~5F";case"~":return"~7E";case"%":return"~"}}));return b.join("-")},h=function(a){if("string"==typeof a)return g(a);for(var b=[],c=0;c<a.length;c++)b.push(g(a[c]));return b.join("_")},i=function(a){for(var b in a)return!1;return!0};a.send=function(b,c){if(!a.config.apiKey||!a.config.apiKey.length)return a.error("Attempted to call send without an API key set, payload dropped"),void 0;if(b&&b.length>0||c&&!i(c)){var d={},e=[];for(var g in a.adapters)a.adapters.hasOwnProperty(g)&&e.push(g+"-"+a.adapters[g].VERSION);d.k=a.config.apiKey,d.c=e.join("_"),d.s=a.sessionID,a.config.visitor?d.e=encodeURIComponent(a.config.visitor):d.v=encodeURIComponent(a.visitorID);var j=[];for(var k in d)d.hasOwnProperty(k)&&j.push(k+"="+d[k]);for(k in c)c.hasOwnProperty(k)&&j.push(k+"="+encodeURIComponent(c[k]));var l=f++,m=a.config.beaconURL+"?"+j.join("&");b&&(m=m+"&p="+h(b)),a.log("Sending request "+l),m.length>2e3&&a.log("Request "+l+": URL is "+m.length+" characters long, this might cause errors in some browsers!");var n=function(){a.log("Completed request "+l)},o=function(){a.log("Failed request "+l+", giving up")},p=function(b,c,d){return function(){a.log("Failed request "+l+", retrying in "+b+" seconds"),window.setTimeout(function(){a.log("Retrying request "+l),d>0?a.dispatchRequest(m,n,p(b*c,c,d-1)):a.dispatchRequest(m,n,o)},1e3*b)}};a.dispatchRequest(m,n,p(30,2,2))}},a.dispatchRequest=function(a,b,c){var d=new Image;"function"==typeof b&&(d.onload=b),"function"==typeof c&&(d.onerror=c),d.src=a},a.adapters={core:a},a.loaded=!0,window.Caliper=a,a.log("Sucessfully loaded caliper.core v"+a.VERSION)}(),function(a,b,c){"use strict";var d={VERSION:"0.0.2"};if(void 0===a||a.loaded!==!0)a.enabled!==!1&&(window.console&&"function"==typeof window.console.error?window.console.error("[Caliper] Failed to load caliper.ember: caliper.core could not be found"):window.console&&"function"==typeof window.console.log&&window.console.error("[Caliper] **ERROR** Failed to load caliper.ember: caliper.core could not be found"));else if(a.plugins&&a.plugins.Ember)a.plugins.Ember.VERSION===d.VERSION?a.warn("Already loaded caliper.ember v"+d.VERSION):a.error("Failed to load caliper.ember v"+d.VERSION+": "+"another version of caliper.ember (v"+a.plugins.Ember.VERSION+") was already loaded");else if(void 0===b)a.error("Failed to load caliper.ember: Ember could not be found");else if(void 0===c)a.error("Failed to load caliper.ember: $ could not be found");else{a.log("Initializing caiper.ember v"+d.VERSION),a.config.enableAjaxFilter=a.config.enableAjaxFilter||!1,a.config.minDuration=a.config.minDuration||50;var e=[],f=function(){return e[e.length-1]},g=function(a,b){this.method=a,this.url=b,this.pending=!0,this.trace=f(),this.trace&&this.trace.events.push(this),this.startTime=Date.now()};g.prototype.stop=function(){this.pending?(this.stopTime=Date.now(),this.pending=!1):a.warn("[BUG] Attempted to stop an AJAX request twice. Please report this to team@caliper.io!")},g.prototype.serialize=function(a){return this.pending===!1?(a=a||0,["a",this.method,this.url,this.startTime-a,this.stopTime-this.startTime]):void 0};var h=function(a){this.viewName=a,this.pending=!0,this.trace=f(),this.trace&&this.trace.events.push(this),this.startTime=Date.now()};h.prototype.stop=g.prototype.stop,h.prototype.serialize=function(a){return this.pending===!1?(a=a||0,["r",this.viewName,this.startTime-a,this.stopTime-this.startTime]):void 0};var i=function(a,b,c){this.klass=a,this.method=b,this.pattern=c,this.events=[],this.finalized=!1,e.push(this),this.startTime=Date.now()};i.prototype.pause=function(){for(var a=1;a<=e.length;a++)e[e.length-a]===this&&e.splice(e.length-a,1)},i.prototype.resume=function(){this.pause(),e.push(this)},i.prototype.finalize=function(){if(this.finalized===!0)return a.warn("[BUG] Attempted to finalize a trace twice. Please report this to team@caliper.io!"),void 0;this.pause();for(var b=0;b<this.events.length;b++)if(this.events[b].pending)return;if(this.stopTime=Date.now(),this.finalized=!0,this.duration=this.stopTime-this.startTime,this.duration<(a.config.minDuration||1))return a.log("Dropped: "+this.klass+"."+this.method+" ("+this.pattern+"), took "+this.duration+"ms. (minDuration is "+a.config.minDuration+"ms)"),void 0;if(a.config.enableAjaxFilter===!0){var c=!1;for(b=0;b<this.events.length;b++)if(this.events[b]instanceof g){c=!0;break}if(!c)return a.log("Dropped: "+this.klass+"."+this.method+" ("+this.pattern+"), took "+this.duration+"ms. (enableAjaxFilter is true)"),void 0}a.log("Sending: "+this.klass+"."+this.method+" ("+this.pattern+"), took "+this.duration+"ms."),this.url=window.location.hash||window.location.pathname;var d={bs:this.startTime,bd:this.duration,bu:this.url};this.klass&&this.klass.length&&(d.bc=this.klass),this.method&&this.method.length&&(d.bm=this.method),this.pattern&&this.pattern.length&&(d.bp=this.pattern);var e=[];for(b=0;b<this.events.length;b++)e.push(this.events[b].serialize(this.startTime));a.send(e,d)};var j=function(a){try{for(var b=a.get("routeName"),c=a.get("router.router.recognizer.names")[b].segments,d=[],e=0;e<c.length;e++){var f=null;try{f=c[e].generate()}catch(g){f=":"+c[e].name}f&&d.push(f)}return"/"+d.join("/")}catch(g){return"/"}},k=function(){var b=j(this),c=f();return c?(c.klass=this.constructor.toString(),c.method=void 0,c.pattern=b):new i(this.constructor.toString(),void 0,b),this._super.apply(this,a.slice(arguments))};b.Route.reopen({beforeModel:k,afterModel:k,enter:k,setup:k}),b.CoreView.reopen({trigger:function(b){var c=this.constructor.toString(),d="Ember"!==c.substr(0,5),e=this.constructor.prototype.hasOwnProperty(b);return!f()&&d&&e&&new i(this.constructor.toString(),b),this._super.apply(this,a.slice(arguments))}});var l=function(a){var b=f();b?"undefined"==typeof b.pattern&&(b.klass=this.constructor.toString(),b.method=a):new i(this.constructor.toString(),a)},m=function(b,c){return"function"==typeof c?a.wrap(c,function(){l.call(this,b),a.__super__()}):c};"undefined"==typeof b.ActionHandler?(b.Route.reopen({init:function(){var a=this._super();for(var b in this.events)this.events.hasOwnProperty(b)&&(this.events[b]=m(b,this.events[b]));return a}}),b.ControllerMixin.reopen({send:function(b){return this[b]&&l.call(this,b),this._super.apply(this,a.slice(arguments))}})):b.ActionHandler.reopen({willMergeMixin:function(a){var b,c=this._super(a);if(a._actions)for(b in a._actions)a._actions.hasOwnProperty(b)&&(a._actions[b]=m(b,a._actions[b]));else if(a.events)for(b in a.events)a.events.hasOwnProperty(b)&&(a.events[b]=m(b,a.events[b]));return c}});var n=new RegExp("<(?:\\(subclass of )?(.*?)\\)?:.*>");b.subscribe("render.view",{before:function(a,b,c){if(f()){var d=c.object.match(n)[1];if("Ember"!==d.substr(0,5)&&"LinkView"!==d)return new h(d)}},after:function(a,b,c,d){d&&d.stop()}}),b.run.backburner.options.onEnd=a.wrap(b.run.backburner.options.onEnd,function(b,c){if(!c&&e.length)for(var d=0;d<e.length;d++)e[d].finalize();return a.__super__()}),a.aliasMethodChain(c,"ajax","instrumentation",a.wrap(c.ajax,function(){if(f()){var b=arguments[1]||arguments[0],c=b.type||"GET",d=b.url||arguments[0];"string"==typeof b&&(b={});var e=new g(c,d);return b.success=a.wrap(b.success,function(){return e.trace.resume(),e.stop(),a.__super__()}),b.error=a.wrap(b.error,function(){return e.trace.resume(),e.stop(),a.__super__()}),b.url=d,a.__super__(b)}return a.__super__()})),a.adapters.Ember=d,a.log("Sucessfully loaded caliper.ember v"+d.VERSION)}}(window.Caliper,a,b)}(window.Ember,window.jQuery||window.Zepto);